{% extends 'Cliente/base.html' %}
{% load static %}

{% block title %}Nueva Orden - {{ lavadero.nombre|default:"" }}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Nueva Orden</li>
      </ol>
    </nav>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header d-flex align-items-center">
        <h5 class="mb-0"><i class="bx bx-pencil-square me-2"></i>Nueva Orden de Lavado</h5>
      </div>
      <div class="card-body">
        {% if formulario.non_field_errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <strong>Errores encontrados:</strong>
          {% for error in formulario.non_field_errors %}
            <div>{{ error }}</div>
          {% endfor %}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <form method="POST" id="orderForm" novalidate>
          {% csrf_token %}

          <!-- SECCIÓN 1: INFORMACIÓN DEL VEHÍCULO -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="bx bx-car-front me-2"></i>Información del Vehículo</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="id_placa" class="form-label">Placa del Vehículo</label>
                  <input type="text" class="form-control {% if vehiculo_form.placa.errors %}is-invalid{% endif %}" 
                    id="id_placa" name="placa" placeholder="ABC-1234" style="text-transform: uppercase;" value="{{vehiculo_form.placa.value|default:''}}">
                  {% if vehiculo_form.placa.errors %}
                    <div class="invalid-feedback">{{ vehiculo_form.placa.errors.0 }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label for="id_tipo" class="form-label">Tipo de Vehículo</label>
                  <select class="form-select {% if vehiculo_form.tipo.errors %}is-invalid{% endif %}" 
                    id="id_tipo" name="tipo">
                    <option value="">Selecciona un tipo...</option>
                    {% for value, label in vehiculo_form.tipo.field.choices %}
                      {% if value %}
                        <option value="{{ value }}">{{ label }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  <small class="form-text text-muted">Selecciona para filtrar servicios disponibles</small>
                  {% if vehiculo_form.tipo.errors %}
                    <div class="invalid-feedback">{{ vehiculo_form.tipo.errors.0 }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label for="id_marca" class="form-label">Marca</label>
                  <input type="text" class="form-control {% if vehiculo_form.marca.errors %}is-invalid{% endif %}" 
                    id="id_marca" name="marca" placeholder="ej: Mazda" value="{{vehiculo_form.marca.value|default:''}}">
                  {% if vehiculo_form.marca.errors %}
                    <div class="invalid-feedback">{{ vehiculo_form.marca.errors.0 }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label for="id_modelo" class="form-label">Modelo</label>
                  <input type="text" class="form-control {% if vehiculo_form.modelo.errors %}is-invalid{% endif %}" 
                    id="id_modelo" name="modelo" placeholder="ej: 2024" value="{{vehiculo_form.modelo.value|default:''}}">
                  {% if vehiculo_form.modelo.errors %}
                    <div class="invalid-feedback">{{ vehiculo_form.modelo.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 2: INFORMACIÓN DEL CLIENTE -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="bx bx-user me-2"></i>Información del Cliente</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="id_nombre" class="form-label">Nombre Completo</label>
                  <input type="text" class="form-control {% if cliente_form.nombre.errors %}is-invalid{% endif %}" 
                    id="id_nombre" name="nombre" placeholder="Nombre del cliente" value="{{cliente_form.nombre.value|default:''}}">
                  {% if cliente_form.nombre.errors %}
                    <div class="invalid-feedback">{{ cliente_form.nombre.errors.0 }}</div>
                  {% endif %}
                </div>
                <div class="col-md-6">
                  <label for="id_celular" class="form-label">Número de Celular</label>
                  <input type="text" class="form-control {% if cliente_form.celular.errors %}is-invalid{% endif %}" 
                    id="id_celular" name="celular" placeholder="3001234567" value="{{cliente_form.celular.value|default:''}}">
                  {% if cliente_form.celular.errors %}
                    <div class="invalid-feedback">{{ cliente_form.celular.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 3: SELECCIONAR SERVICIOS -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="bx bx-star me-2"></i>Seleccionar Servicios</h6>
            </div>
            <div class="card-body">
              <div id="servicesContainer">
                <!-- Los servicios se mostrarán aquí cuando selecciones un tipo de vehículo -->
                <div class="alert alert-info mb-0" id="serviciosAviso">
                  <i class="bx bx-info-circle me-2"></i>Selecciona un tipo de vehículo para ver los servicios disponibles
                </div>
              </div>
              
              <!-- Contenedor oculto con datos de servicios por categoría -->
              <div id="serviciosData" style="display: none;">
                {% for categoria, servicios in servicios_por_categoria.items %}
                  <div class="servicios-categoria" data-categoria="{{ categoria }}">
                    {% for servicio in servicios %}
                      <div class="servicio-item" data-id="{{ servicio.id }}" data-precio="{{ servicio.precio }}" data-nombre="{{ servicio.nombre }}" data-descripcion="{{ servicio.descripcion }}"></div>
                    {% endfor %}
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- SECCIÓN 4: OBSERVACIONES -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="bx bx-chat-left-text me-2"></i>Observaciones Adicionales</h6>
            </div>
            <div class="card-body">
              <label for="id_observaciones" class="form-label">Observaciones</label>
              <textarea class="form-control {% if orden_form.observaciones.errors %}is-invalid{% endif %}" 
                id="id_observaciones" name="observaciones" rows="4" 
                placeholder="Detalles especiales o instrucciones sobre el lavado">{{ orden_form.observaciones.value|default_if_none:'' }}</textarea>
              <small class="form-text text-muted">Detalles especiales o instrucciones sobre el lavado</small>
              {% if orden_form.observaciones.errors %}
                <div class="invalid-feedback">{{ orden_form.observaciones.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- RESUMEN DE ORDEN -->
          <div class="card mb-4 bg-light border-0">
            <div class="card-body">
              <h6 class="card-title mb-3"><i class="bx bx-receipt me-2"></i>Resumen de Orden</h6>
              <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <span>Subtotal:</span>
                <span class="fw-bold" id="subtotal">$0</span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold">Total a Pagar:</span>
                <span class="badge bg-success px-3 py-2 fs-6" id="total">$0</span>
              </div>
            </div>
          </div>

          <!-- BOTONES DE ACCIÓN -->
          <div class="row">
            <div class="col-6">
              <button type="submit" class="btn btn-primary w-100" id="guardarImprimirBtn">
                <i class="bx bx-check-circle me-2"></i>Guardar e Imprimir Orden
              </button>
            </div>
            <div class="col-6">
              <a href="{% url 'dashboard' %}" class="btn btn-secondary w-100">
                <i class="bx bx-x-circle me-2"></i>Cancelar
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% block page_js %}
<script src="{% static 'Cliente/js/nueva_orden.js' %}"></script>
<script>
// Mapeo de tipos de vehículo a categorías de servicios
const tipoVehiculoACategoriaMap = {
  'CARRO': 'CARRO',
  'MOTO': 'MOTO',
  'CAMIONETA_5': 'CAMIONETA_5',
  'CAMIONETA_7': 'CAMIONETA_7',
  'BICICLETA': 'BICICLETA'
};

// Datos de servicios organizados por categoría
const serviciosPorCategoria = {};

// Extraer datos de servicios del DOM
document.addEventListener('DOMContentLoaded', function() {
  const categoriaElements = document.querySelectorAll('.servicios-categoria');
  
  categoriaElements.forEach(catElement => {
    const categoria = catElement.getAttribute('data-categoria');
    const servicios = [];
    
    const servicioItems = catElement.querySelectorAll('.servicio-item');
    servicioItems.forEach(item => {
      servicios.push({
        id: item.getAttribute('data-id'),
        nombre: item.getAttribute('data-nombre'),
        descripcion: item.getAttribute('data-descripcion'),
        precio: parseFloat(item.getAttribute('data-precio'))
      });
    });
    
    serviciosPorCategoria[categoria] = servicios;
  });
  
  // Event listener para cambio de tipo de vehículo
  const tipoVehiculoSelect = document.getElementById('id_tipo');
  const servicesContainer = document.getElementById('servicesContainer');
  const serviciosAviso = document.getElementById('serviciosAviso');
  
  if (tipoVehiculoSelect) {
    tipoVehiculoSelect.addEventListener('change', function() {
      const tipoId = this.value;
      console.log('Tipo seleccionado:', tipoId);
      
      if (!tipoId) {
        servicesContainer.innerHTML = `
          <div class="alert alert-info mb-0" id="serviciosAviso">
            <i class="bx bx-info-circle me-2"></i>Selecciona un tipo de vehículo para ver los servicios disponibles
          </div>
        `;
        return;
      }
      
      // Obtener la categoría correspondiente al tipo de vehículo
      const categoria = tipoVehiculoACategoriaMap[tipoId];
      const servicios = serviciosPorCategoria[categoria] || [];
      
      if (servicios.length > 0) {
        let serviciosHTML = '';
        
        servicios.forEach(servicio => {
          serviciosHTML += `
            <div class="form-check mb-3 p-3 border rounded" data-categoria="${categoria}" data-precio="${servicio.precio}">
              <input class="form-check-input service-checkbox" type="checkbox" name="servicios" value="${servicio.id}" 
                id="servicio_${servicio.id}" data-price="${servicio.precio}">
              <label class="form-check-label w-100" for="servicio_${servicio.id}">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="mb-1">${servicio.nombre}</h6>
                    ${servicio.descripcion ? `<small class="text-muted">${servicio.descripcion}</small>` : ''}
                  </div>
                  <span class="badge bg-primary">$${parseFloat(servicio.precio).toFixed(0)}</span>
                </div>
              </label>
            </div>
          `;
        });
        
        servicesContainer.innerHTML = serviciosHTML;
        agregarEventListenersServicios();
      } else {
        servicesContainer.innerHTML = `
          <div class="alert alert-warning mb-0">
            <i class="bx bx-exclamation-triangle me-2"></i>No hay servicios disponibles para este tipo de vehículo
          </div>
        `;
      }
    });
  }
  
  function agregarEventListenersServicios() {
    const checkboxes = document.querySelectorAll('.service-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', calcularTotal);
    });
  }
  
  function calcularTotal() {
    const checkboxes = document.querySelectorAll('.service-checkbox:checked');
    let total = 0;
    
    checkboxes.forEach(checkbox => {
      const precio = parseFloat(checkbox.getAttribute('data-price')) || 0;
      total += precio;
    });
    
    document.getElementById('subtotal').textContent = `$${total.toFixed(0)}`;
    document.getElementById('total').textContent = `$${total.toFixed(0)}`;
  }
  
  agregarEventListenersServicios();
});
</script>
{% endblock %}
{% endblock %}